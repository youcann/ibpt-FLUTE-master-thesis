\chapter{Interfacing FLUTE}
This chapter covers methods on interfacing the FLUTE accelerator, that is how to read diagnostic measurements into the control system from FLUTE and how to influence the electron acceleration appropriately to achieve stabilization.\\
In this chapter \textit{input} and \textit{output} refer to the view from the control system.

\section{Inputs}
FLUTE uses the \textit{Experimental Physics and Industrial Control System (EPICS)}\cite{Dalesio1991} for control of various parts of the accelerator, to send real time data to be archived and to build user interfaces via \textit{Control System Studio (CSS)}\cite{CSS2021}, a JAVA based integrated development environment (IDE).

EPICS offers client/server and publish/subscribe paradigms to access data in so called process variables (PV) through channels. Modules are usually written in the C programming language. To ease the access to EPICS channels in programs written with the Python language, the package \textit{PyEpics}\cite{Newville2019} can be used. Since all data of interest as input for the control system can be extracted through an EPICS channel, the next section deals with using PyEpics to obtain the data.

\subsection{Accessing EPICS channels in Python with PyEpics}
Before usage PyEpics needs to be installed, e.g. with \texttt{pip3 install pyepics} from the \textit{PyPi} repository. If the computer running the Python code can reach the EPICS CA repeater on the machine network, the connection is established automatically in the background. To get a channel value asynchronously, i.e. at an arbitrary time, the function \texttt{caget(pvname)} can be used with the name of the desired process value, see \autoref{lst:caget}.

\begin{lstlisting}[style=python,caption = Using \texttt{caget()} to get the value of an EPICS process value, label = lst:lst-caget]
from epics import caget
print(f"Cavity RF power: {caget('F:RF:LLRF:01:GunCav1:Power:Out')}")
\end{lstlisting}

Another way is to setup a channel object and create a subscription with an user defined callback function that is executed each time the process variable changes. This implements synchronous access to the PV and can be compared to an interrupt rather than polling the variable as in \autoref{lst:lst-caget}.\\
For a non trivial example see \autoref{lst:create_subscription}. In this program, the time differences between new values and their statistics are printed to the console.

\begin{lstlisting}[style=python,caption = Using a user defined callback function to access an EPICS process value, label = lst:create_subscription]
from epics import ca
import time
import numpy as np

dts=np.array([])
lastCalled=time.time()

def call(pvname, value, **kwargs):
	global lastCalled, dts
	now=time.time()
	dt=now-lastCalled
	lastCalled=now
	dts=np.append(dts, dt)

chid=ca.create_channel("F:RF:LLRF:01:GunCav1:Power:Out")
_ , _ , eventID=ca.create_subscription(chid, callback=call, use_time=True)

while(True):
	time.sleep(2)
	print(f"N:{len(dts)},mean:{np.mean(dts)},min:{np.min(dts)},max:{np.max(dts)},std:{np.std(dts)}")
\end{lstlisting}




\subsection{Properties of the Available Process Variables}
In this section some process variables that may be used as inputs for the control system are analyzed. These are:
\begin{itemize}
\item \texttt{F:RF:LLRF:01:GunCav1:Power:Out Value}: The RF power measured immediately before the cavity
\item \texttt{F:AX:DAQDT:01:1:Wave:05:Sample Value}: The charge measured with a Faraday cup (RadiaBeam Technologies FARC-04 \cite{radiabeamFaradayCups}) and amplified with a charge sensitive amplifier (PCB 421A25 \cite{pcbsynotechPCB421A25Charge})
\item \texttt{F:INJ-1:Gun:01:Temperature:Body Value}: The body temperature of the cavity
\end{itemize}

In \autoref{fig:quantNoise} all three are plotted for a duration of \SI{15}{\minute} without any interference to the system and the system being in steady state operation.

\begin{figure}[tb]
		\hfill
        \subfloat[Cavity RF power \texttt{F:RF:LLRF:01:GunCav1:Power:Out Value}]{\input{chap/InterfacingFlute/img/Inputs/RF.tikz}}
        
        \hfill
        \subfloat[Faraday cup charge \texttt{F:AX:DAQDT:01:1:Wave:05:Sample Value}]{\input{chap/InterfacingFlute/img/Inputs/FaradayCup.tikz}}
        
        \hfill
        \subfloat[Cavity body temperature \texttt{F:INJ-1:Gun:01:Temperature:Body Value}]{\input{chap/InterfacingFlute/img/Inputs/BodyTemp.tikz}}
       \caption{Comparing the quantization noise of three process variables}
    \label{fig:quantNoise}
\end{figure}

\begin{table}[tb]
\caption{Comparing quantization steps}\label{tab:interfacingFlute_quantSteps}
\centering
\begin{tabular}{lSSS}
\toprule
PV & {$N_{unique}$} & {$q_{avg}$} & {$q_{norm}$}\\
\midrule
F:RF:LLRF:01:GunCav1:Power:Out Value  & 84 & 0.6935 & 0.011904\\
F:AX:DAQDT:01:1:Wave:05:Sample Value  & 22 & 0.015  & 0.04545\\
F:INJ-1:Gun:01:Temperature:Body Value & 18 & 0.1294 & 0.05555\\
\bottomrule
\end{tabular}
\end{table}


In addition the sample times of the process variables is examined if the method with a custom callback is used (see \autoref{lst:create_subscription}) or the data is extracted from the archive. The differences in the sample times are calculated according to
\begin{equation}
\Delta=t_{n+1}-t_n.
\end{equation}
Then a histogram with the relative frequency on the y axis is used as an estimator for the probability density function of the sample time intervals (see \autoref{fig:interfacingFlute_sampleTimesHist}). The histogram shows that the time series resulting from recording process variables out of the EPICS system are highly unevenly spaced. Thus the data needs to be converted to posses evenly spaced sample times to use common signal processing methods like the DFT or digital LTI filters. For offline analysis of prerecorded data, it can easily be resampled to a fixed time grid. But for online operation of a filter or a whole control system it is not possible to use an arbitrary resample method because they are often non causal or introduce significant group delay when made causal. Instead calling \texttt{caget()} with a (software-) timer can be used to get evenly spaced samples online.

\begin{figure}[tb]
\centering
\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Inputs/dtHistogram.tikz}
\caption{Histogram of the sample time intervals $\Delta$ of the plots in \autoref{fig:quantNoise}}
\label{fig:interfacingFlute_sampleTimesHist}
\end{figure}






\section{Output: Controllable RF Attenuator}
The output signal computed by the control systems has to have a way of influencing the RF power send to the cavity. This could be done over an EPICS channel (e.g. with the PyEpics function \texttt{caput()} to set the value of a process variable via a channel access). However to make it possible to move the control system from a general purpose personal computer to a dedicated digital signal processor, FPGA or similar in the future, using a physical device in the signal path is preferred.\\

\subsection{Defining Requirements}


\begin{table}[tb]
\caption{Requirements for the controllable RF attenuator}
\label{tab:interfacing-flute_rfattenrequirements}
\centering
\begin{tabular}{lS}
\toprule
Requirement & {Value/Range}\\
\midrule
minimum attenuation & \\
maximum attenuation & \\
attenuation resolution & \\
setup time & \\
operating temperature range & \\
supply voltage & \\
control voltage & \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Evaluation of the ZX73-2500-S+ Controllable RF Attenuator}
The \textit{ZX73-2500-S+} is a voltage controllable RF attenuator with coaxial SMA connectors by the company Mini-Circuits. As there is no alternative model from Mini-Circuits and devices from other manufactures are offered with similar specifications, only the ZX73-2500-S+ is evaluated in detail in this section.

The ZX73-2500-S+ attenuator consists of a brass housing/shielding containing the Mini-Circuits RVA-2500+, a variable SMD attenuator in the DV874 case form factor. The RF input and output are connected with female SMA screw connectors. The power supply and control voltage are connected with solder pins. In order to use shielded cables and a reliable connection, for all measurements SMA connectors are soldered to the supply and control pins. According to equivalent circuit in the data sheet\cite{mini-circuitsZX732500VoltageVariable} it can be assumed it is based on the common quad-$\pi$ pin diode design\cite{waughLowCostSurfaceMount1992}.

The attenuation versus frequency measurements from the manufactures data sheet are redone to both get a first impression of the device and verify it is generally operational and also as a sanity check for the used laboratory test equipment.
Because the signal used by the FLUTE RF system is a \SI{3}{\GHz} single harmonic, the frequency measurement range is augmented over the maximum of \SI{2.5}{\GHz} in the data sheet to \SI{4}{\GHz}.
Between the measurement of each network analyzer trace, the control voltage $V_{control}$ of the attenuator is set to \SI{0}{\volt}, \SI{2}{\volt}, \SI{4}{\volt}, \SI{6}{\volt} or \SI{12}{\volt}.
The result is shown in \autoref{fig:interfacingFlute_atteneval-overview-NA}\footnote{A through calibration of the network analyzer reduces the influence of the cables and connectors on the measurement. Change in attenuation due to play in the connectors and slight bend changes in the cables exceed the trace noise (\SI{0.004}{\dB rms}) and cause an uncertainty of about \SI{0.5}{\dB}}.
When comparing the measured plots to the plots in the data sheet, there are obvious discrepancies. For $V_{control}=\SI{0}{\volt}$ the attenuator is very susceptible to noise on the control input, which could explain the differences for this curve. In the case of \SI{2}{\volt} and \SI{4}{\volt}, the almost constant offset scales with a similar logarithmic fashion as the attenuation does, which suggests device tolerances causing the deviations.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/attenuationOverFrequency_Vctrl.tikz}
	\caption{Attenuation vs. frequency over DC control voltage; measured with network analyzer (see \ref{app:agilent-e5071c}, parameters: $\#AVG$: 16, $IF\text{-}BW$: \SI{10}{\kHz}); plotted in dashed lines are the measurements from the data sheet (see \cite[p.~2]{mini-circuitsZX732500VoltageVariable})}
	\label{fig:interfacingFlute_atteneval-overview-NA}
\end{figure}

From this quick examination it is not possible to predict how the attenuator behaves for small changes in $V_{control}$ and how changes in the environment, such as the body temperature or the supply voltage, cause unwanted variations in the attenuation. 

For this reason, the ZX73-2500-S+ is examined in greater detail with different measurement setups in the next sections.

%todo what is measured?

\subsubsection{Common Measurement Setup}
For the following measurements a common setup is used to ease the recording of data and the sequential control for parameter studies. The needed tasks are:
\begin{itemize}
\item Supply the attenuator with the supply voltage $V_+$
\item Supply the attenuator with the adjustable control voltage $V_control$
\item Supply the RF input power
\item Measure the RF output power
\item Record all data as time series to a computers storage device
\end{itemize}

To achieve this, the setup in \autoref{fig:interfacingFlute_atteneval-setup} is used.
The supply and control voltage are generated by a Keysight 34972A with a 34907A module (see \autoref{app:keysight-34972A}).
To get a more accurate measurement of the actual voltages, two digital multimeters(Models 34470A and 34411A, see \autoref{app:keysight-34470A}) are connected directly at the $V_{control}$ and $V_+$ pins.
The RF signal is generated by a Rhode und Schwarz SMC 100A signal generator.
With the HP E4419B and its two inputs and a power splitter, it is possible to directly get the attenuation of the ZX73-2500-S+.
The body temperature of the device is monitored with a PT100 temperature sensor connected to the 34972A.

Each of the lab devices used is compatible with VXI11, which is a widely adopted standard that is used to send ASCII SCPI commands over an ethernet network (called LXI) or GPIB \cite{lxi2021}.
This enables remote and programatically control of the devices over the network.
With the library \textit{python-vxi11}, it is now possible to write a custom script, that sets the measurement devices to known initial conditions, drives the inputs of the attenuator and records the generated data.
The whole setup of the hardware in \autoref{fig:atteneval-setup} and the Python software, a measurement frequency of about \SI{0.5}{\Hz} to \SI{1}{\Hz} can be achieved, which is enough because most measurements taken are of a static nature and in the case of the temperature influence measurement, the thermal time constant is in the order of a few seconds.
The limiting device is the HP E4419B which takes the longest to perform one measurement. Without it, measurement frequencies of over \SI{4}{\Hz} are possible.

All measurements are performed in the ``RF lab'' in building 348 (KARA hall on KIT Campus North) which is air conditioned to about \SI{20(2)}{\celsius}.

\begin{figure}[tb]
	\centering
	\includegraphics[]{chap/InterfacingFlute/img/Output/schematic.tikz}
	\caption{Measurement setup: DUT(red), RF generator/power splitter/meter(blue),\\ DC sources/meters(green), temperature probe(yellow)}
	\label{fig:interfacingFlute_atteneval-setup}
\end{figure}

\subsubsection{Relation between Control Voltage and Attenuation}
The measured spectra in \autoref{fig:interfacingFlute_atteneval-overview-NA} already suggest that there is a non linear relationship between the control voltage $V_{control}$ and the attenuation $A$ of the attenuator:
\begin{equation}
A=A(V_{control},f) \neq const. \cdot V_{control} \cdot A(f).
\end{equation}
This also means the sensitivity
\begin{equation}
S(V_{control},f)=\frac{\d{A(V_{control},f)}}{\d{V_{control}}}
\end{equation}
(for a fixed frequency) is not constant.
In other words, for a desired relative change in attenuation, the needed adjustment in $V_{control}$ depends on the chosen operating point $A_0:=A(V_{control,0},f_0)$.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/attenAndDattten.tikz}
	\caption{}
	\label{fig:interfacingFlute_attenDatten}
\end{figure}

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/attenAndDatttenZoomed.tikz}
	\caption{}
	\label{fig:interfacingFlute_attenDattenZoomed}
\end{figure}


\subsubsection{Influence of Supply Voltage Noise on Attenuation}
\subsubsection{Influence of Body Temperature Variations on Attenuation}
\subsubsection{Influence of Small Changes in RF Frequency on Attenuation}
\subsubsection{Final Test of the Attenuator in the FLUTE LLRF Cabinet}




\subsection{Conclusion}





