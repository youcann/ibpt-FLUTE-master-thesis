\chapter{Interfacing FLUTE}
This chapter covers methods on interfacing the FLUTE accelerator, that is how to read diagnostic measurements into the control system from FLUTE and how to influence the electron acceleration appropriately to achieve stabilization.\\
In this chapter \textit{input} and \textit{output} refer to the view from the control system.

\section{Inputs}
FLUTE uses the \textit{\gls{epics}}\cite{Dalesio1991} for control of various parts of the accelerator, to archived time series data and to build user interfaces via \textit{\gls{css}}\cite{CSS2021}, a development studio based on the Java \gls{ide} Eclipse. \cite{Mexner2018}

\Gls{epics} offers client/server and publish/subscribe paradigms to access data in so called \gls{pv} through channels. Modules are usually written in the C programming language. To ease the access to \gls{epics} channels in programs written with the Python language, the package \textit{PyEpics}\cite{Newville2019} can be used. Since all data of interest as input for the control system can be extracted through an \gls{epics} channel, the next section deals with using PyEpics to obtain the data.

\subsection{Accessing EPICS channels in Python with PyEpics}
Before usage PyEpics needs to be installed, e.g. with \texttt{pip3 install pyepics} from the \textit{PyPi} repository. If the computer running the Python code can reach the \gls{epics} \gls{ca} repeater on the machine network, the connection is established automatically in the background. To get a channel value asynchronously, i.e. at an arbitrary time, the function \texttt{caget(pvname)} can be used with the name of the desired process value, see \autoref{lst:caget}.

\begin{lstlisting}[style=python,caption = Using \texttt{caget()} to get the value of an EPICS process value, label = lst:caget]
from epics import caget
print(f"Cavity RF power: {caget('F:RF:LLRF:01:GunCav1:Power:Out')}")
\end{lstlisting}

Another way is to setup a channel object and create a subscription with an user defined callback function that is executed each time the process variable changes. This implements synchronous access to the PV and can be compared to an interrupt rather than polling the variable as in \autoref{lst:caget}.\\
For a non trivial example see \autoref{lst:create_subscription}. In this program, the time differences between new values and their statistics are printed to the console.

\begin{lstlisting}[style=python,caption = Using a user defined callback function to access an EPICS process value, label = lst:create_subscription]
from epics import ca
import time
import numpy as np

dts=np.array([])
lastCalled=time.time()

def call(pvname, value, **kwargs):
	global lastCalled, dts
	now=time.time()
	dt=now-lastCalled
	lastCalled=now
	dts=np.append(dts, dt)

chid=ca.create_channel("F:RF:LLRF:01:GunCav1:Power:Out")
_ , _ , eventID=ca.create_subscription(chid, callback=call, use_time=True)

while(True):
	time.sleep(2)
	print(f"N:{len(dts)},mean:{np.mean(dts)},min:{np.min(dts)},max:{np.max(dts)},std:{np.std(dts)}")
\end{lstlisting}




\subsection{Properties of the Available Process Variables}
In this section some process variables that may be used as inputs for the control system are analyzed. These are:
\begin{itemize}
\item \texttt{F:RF:LLRF:01:GunCav1:Power:Out Value}: The \gls{rf} power measured in the half cell of the gun cavity
\item \texttt{F:AX:DAQDT:01:1:Wave:05:Sample Value}: The charge measured with a Faraday cup (RadiaBeam Technologies FARC-04 \cite{radiabeamFaradayCups}) and amplified with a charge sensitive amplifier (PCB 421A25 \cite{pcbsynotechPCB421A25Charge})
\item \texttt{F:INJ-1:Gun:01:Temperature:Body Value}: The body temperature of the cavity
\end{itemize}

In \autoref{fig:quantNoise} all three are plotted for a duration of \SI{15}{\minute} without any interference to the system and the system being in steady state operation.

\begin{figure}[tb]
		\hfill
        \subfloat[Cavity \gls{rf} power \texttt{F:RF:LLRF:01:GunCav1:Power:Out Value}]{\input{chap/InterfacingFlute/img/Inputs/RF.tikz}}
        
        \hfill
        \subfloat[Faraday cup charge \texttt{F:AX:DAQDT:01:1:Wave:05:Sample Value}]{\input{chap/InterfacingFlute/img/Inputs/FaradayCup.tikz}}
        
        \hfill
        \subfloat[Cavity body temperature \texttt{F:INJ-1:Gun:01:Temperature:Body Value}]{\input{chap/InterfacingFlute/img/Inputs/BodyTemp.tikz}}
       \caption{Comparing the quantization noise of three process variables}
    \label{fig:quantNoise}
\end{figure}

\begin{table}[tb]
\caption{Comparing quantization steps}\label{tab:interfacingFlute_quantSteps}
\centering
\begin{tabular}{lSSS}
\toprule
PV & {$N_{unique}$} & {$q_{avg}$} & {$q_{norm}$}\\
\midrule
F:RF:LLRF:01:GunCav1:Power:Out Value  & 84 & 0.6935 & 0.011904\\
F:AX:DAQDT:01:1:Wave:05:Sample Value  & 22 & 0.015  & 0.04545\\
F:INJ-1:Gun:01:Temperature:Body Value & 18 & 0.1294 & 0.05555\\
\bottomrule
\end{tabular}
\end{table}


In addition the sample times of the process variables is examined if the method with a custom callback is used (see \autoref{lst:create_subscription}) or the data is extracted from the archive. The differences in the sample times are calculated according to
\begin{equation}
\Delta=t_{n+1}-t_n.
\end{equation}
Then a histogram with the relative frequency on the y axis is used as an estimator for the probability density function of the sample time intervals (see \autoref{fig:interfacingFlute_sampleTimesHist}). The histogram shows that the time series resulting from recording process variables out of the EPICS system are highly unevenly spaced. Thus the data needs to be converted to posses evenly spaced sample times to use common signal processing methods like the \gls{dft} or digital \gls{lti} filters. For offline analysis of prerecorded data, it can easily be resampled to a fixed time grid. But for online operation of a filter or a whole control system it is not possible to use an arbitrary resample method because they are often non causal or introduce significant group delay when made causal. Instead calling \texttt{caget()} with a (software-) timer can be used to get evenly spaced samples online.

\begin{figure}[tb]
\centering
\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Inputs/dtHistogram.tikz}
\caption{Histogram of the sample time intervals $\Delta$ of the plots in \autoref{fig:quantNoise}}
\label{fig:interfacingFlute_sampleTimesHist}
\end{figure}

\subsection{Filtering the RF power Signals}
In case of the klystron output \gls{rf} power or the power at the cavity, filtering of the signal is needed to remove zero outliers.
These outliers occur if a high voltage arc occurs inside the cavity. This is detected and the \gls{llrf} control system shuts off the \gls{rf} power for the current pulse (called a ``breakdown'').
These outliners are not representative of the average \gls{rf} power inside the cavity over multiple pulses and thus would greatly impair the controller performance.
For that reason, before any further filtering to remove noise etc, a breakdown removal filter is used (\autoref{lst:control-system-breakdownremoval}).
In principle the new power value is checked to be inside a band the size of which is determined by the mean deviation of the $N_{filt}$ previous values and a scaling $m$.
The percentile differences are used here as they are robust against outliers (i.e. other breakdowns) in the $N_{filt}$ previous values opposed to a normal standard deviation.
The scaling with $(2*1.2815)^{-1}$ is used to make the mean deviation comparable to a standard deviation.

\begin{lstlisting}[style=python,caption = Breakdown removal filtering, label = lst:control-system-breakdownremoval]
if(abs(P[i]-np.median(P[i-3*Nfilt:i-Nfilt])) <
m*(np.percentile(P[i-3*Nfilt:i-Nfilt],90)-np.percentile(P[i-3*Nfilt:i-Nfilt],10)/(2*1.2815))):
   P_filt=np.append(P_filt,P[i])
else:
   breakdown_locations_predicted=np.append(breakdown_locations_predicted,i)
   P_filt=np.append(P_filt,np.median(P[i-3*Nfilt:i-Nfilt]))
\end{lstlisting}





\section{Output: Controllable RF Attenuator}\label{sec:atteneval}
The output signal computed by the control systems has to have a way of influencing the \gls{rf} power sent to the cavity. This could be done over an \gls{epics} channel (e.g. with the PyEpics function \texttt{caput()} to set the value of a process variable via a channel access). However to make it possible to move the control system from a general purpose personal computer to a dedicated digital signal processor, \gls{fpga} or similar in the future, using a physical device in the signal path is preferred.\\

\subsection{Defining Requirements}
The controllable attenuator should allow to vary the attenuation in a span big enough to counteract typical instabilities on the \gls{flute} \gls{rf} power. The set attenuation should be stable. This is especially needed in cases where the control system is not enabled. Then the attenuator should not add noise or drift to stay ``transparent'' for other systems. To allow for other attenuator or amplifiers in the signal path to compensate the attenuation around its operating point, the nominal attenuation should be as low as possible. The attenuation resolution should be low enough to allow for fine control and not to add noticeable quantization noise. Also the setup time for a new value should be small enough to not be visible to the control system.

Other factors like the control/supply voltages and the operating temperature range are limited by the available hardware or governed by the mounting location.

All requirements are summarized in \autoref{tab:interfacingFlute_rfattenrequirements}.

\begin{table}[tbh]
\caption{Requirements for the controllable \gls{rf} attenuator}
\label{tab:interfacingFlute_rfattenrequirements}
\centering
\begin{tabular}{lc}
\toprule
Requirement & {Value/Range}\\
\midrule
attenuation adjustment & \SI{\pm0.2}{\dB}\\
attenuation stability & \SI{\pm0.001}{\dB}\\
nominal attenuation at operating point & < \SI{10}{\dB}\\
attenuation resolution & \SI{0.001}{\dB}\\
setup time & \SI{10}{\milli\second}\\
operating temperature range & \SI{25\pm0.1}{\celsius}\\
supply voltage & \SIrange{3}{12}{\volt}\\
control voltage & \SIrange{3}{12}{\volt}\\
\bottomrule
\end{tabular}
\end{table}

\subsection{Evaluation of the ZX73-2500-S+ Controllable RF Attenuator}
The \textit{ZX73-2500-S+} is a voltage controllable \gls{rf} attenuator with coaxial SMA connectors by the company Mini-Circuits. As there is no alternative model from Mini-Circuits and devices from other manufacturers are offered with similar specifications, only the ZX73-2500-S+ is evaluated in detail in this section.



\begin{figure}[tb]
    \centering
		\subfloat[left: ZX73-2500-S+ with cover; right: cover removed showing RVA-2500+ and a buffer capacitor ]{\input{chap/InterfacingFlute/img/Output/attenuatorOverview/attenPhoto.tikz}}
		\\
		\subfloat[equivalent circuit from the manufacturer (redrawn from  \cite{mini-circuitsZX732500VoltageVariable})]{\input{chap/InterfacingFlute/img/Output/attenuatorOverview/attenCequi.tikz}}
		\caption{The ZX73-2500-S+ controllable \gls{rf} attenuator by Mini-Circuits}
    \label{fig:attenPhotoAndEquiC}
\end{figure}

\begin{figure}[tb]
    \centering
	\input{chap/InterfacingFlute/img/Output/attenuatorOverview/quadPiCequi.tikz}
	\caption{Controllable attenuator design around the HP HSMP-3814 \gls{rf} PIN diodes (redrawn and simplified from \cite{waughLowCostSurfaceMount1992})}
    \label{fig:quadPiequiC}
\end{figure}




The ZX73-2500-S+ attenuator consists of a brass housing/shielding containing the Mini-Circuits RVA-2500+, a variable SMD attenuator in the DV874 case form factor. The \gls{rf} input and output are connected with female SMA screw connectors. The power supply and control voltage are connected with solder pins. In order to use shielded cables and a reliable connection, for all measurements SMA connectors are soldered to the supply and control pins. According to equivalent circuit in the data sheet \cite{mini-circuitsZX732500VoltageVariable}, it can be assumed it is based on the common quad-$\pi$ pin diode design introduced in \cite{waughLowCostSurfaceMount1992}. In this attenuator design, the resistors in a fixed $\pi$-configuration attenuator are switched out for \gls{rf} PIN diodes with the appropriate biasing and matching resistors and capacitors, see \autoref{fig:quadPiequiC}. At high frequencies, PIN diodes behave like resistors with the differential resistance
\begin{equation}
r_d = f(I_F)
\end{equation}
being an inverse function of the forward bias current, which makes the attenuator adjustable.

The attenuation versus frequency measurements from the manufactures data sheet are redone to both get a first impression of the device and verify it is generally operational and also as a sanity check for the used laboratory test equipment.
Because the signal used by the FLUTE \gls{rf} system is a \SI{3}{\GHz} single harmonic, the frequency measurement range is augmented over the maximum of \SI{2.5}{\GHz} in the data sheet to \SI{4}{\GHz}.
Between the measurement of each network analyzer trace, the control voltage $V_{control}$ of the attenuator is set to \SI{0}{\volt}, \SI{2}{\volt}, \SI{4}{\volt}, \SI{6}{\volt} or \SI{12}{\volt}.
The result is shown in \autoref{fig:interfacingFlute_atteneval-overview-NA}\footnote{A thru calibration of the network analyzer reduces the influence of the cables and connectors on the measurement. The change in attenuation due to play in the connectors and slight bend changes in the cables exceeds the trace noise (\SI{0.004}{\dB rms}) and causes an uncertainty of about \SI{0.5}{\dB}}.
When comparing the measured plots to the plots in the data sheet, there are obvious discrepancies. For $V_{control}=\SI{0}{\volt}$ the attenuator is very susceptible to noise on the control input, which could explain the differences for this curve. In the case of \SI{2}{\volt} and \SI{4}{\volt}, the almost constant offset scales with a similar logarithmic fashion as the attenuation does, which suggests device tolerances causing the deviations.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/attenuationOverFrequency_Vctrl.tikz}
	\caption{Attenuation vs. frequency over DC control voltage; measured with network analyzer (see \ref{app:agilent-e5071c}, parameters: $\#AVG$: 16, $IF\text{-}BW$: \SI{10}{\kHz}); plotted in dashed lines are the measurements from the data sheet (see \cite[p.~2]{mini-circuitsZX732500VoltageVariable})}
	\label{fig:interfacingFlute_atteneval-overview-NA}
\end{figure}

From this quick examination it is not possible to predict how the attenuator behaves for small changes in $V_{control}$ and how changes in the environment, such as the body temperature or the supply voltage, cause unwanted variations in the attenuation. 

For this reason, with different measurement setups, the ZX73-2500-S+ is examined in greater detail in the next sections.

To compare desired and spurious influences on the attenuation, the following model is used.\\
The attenuation of the ZX73-2500-S+ $A$ depends on the control voltage $V_{control}$ but also on the supply voltage $V+$, the case temperature $\vartheta_{case}$ and the \gls{rf} frequency $f$:
\begin{equation}
A=A(\underbrace{V_{control},\,V_+,\,\vartheta_{case},\,f}_{\vec{x}}) = A\left(\vec{x}\right)
\end{equation}
Other influences are not modeled as they are difficult to control, such as the manufacturing tolerances between different devices, or assumed to be negligible, such as component degradation or humidity.

In the next sections, the influence of each component of the parameter vector $\vec{x}$ on $A$ is measured. As a coarse approximation, all influences are assumed to have linear effect. Then the total derivative of $A$, $\Delta A$ can be written as
\begin{equation}\label{eq:interfacingFlute_linearApprox}
\underbrace{A(\vec{x}-\vec{x_o})-A(\vec{x_o})}_{\Delta A} = \sum_{j=0}^{3} \frac{\Delta A}{\Delta x_j} \Delta x_j
\end{equation}
where the $\nicefrac{\Delta A}{\Delta x_j}$ approximate the partial derivatives $\nicefrac{\d{A}}{\d{x_j}}$.

With \autoref{eq:interfacingFlute_linearApprox}, the maximum error on the attenuation, that is the variation around the operating point with a fixed $V_{control}$, can be approximated with
\begin{equation}\label{eq:interfacingFlute_maxerror}
\Delta A_{\text{max}} = \sum_{j=0}^{3} \left|\frac{\Delta A}{\Delta x_j} \cdot \Delta x_j\right| 
= \sum_{j=0}^{3} \left|\frac{\Delta A}{\Delta x_j}\right| \cdot \left|\Delta x_j\right|.
\end{equation}

If not specified otherwise, the operating point
\begin{align}\label{eq:interfacingFlute_operatingpoint}
A(\vec{x_o}) =: A_o &= A(V_{control},\,V_+,\,\vartheta_{case},\,f)\\
A_o                 &= A\left(\SI{10}{\volt},\,\SI{3}{\volt},\,\SI{20}{\celsius},\,\SI{3}{\GHz}\right)
\end{align}
is used.

\subsubsection{Common Measurement Setup}
For the following measurements a common setup is used to ease the recording of data and the sequential control for parameter studies. The needed tasks are:
\begin{itemize}
\item Supply the attenuator with the supply voltage $V_+$
\item Supply the attenuator with the adjustable control voltage $V_{control}$
\item Supply the \gls{rf} input power with variable frequency $f$
\item Measure the \gls{rf} output power
\item Record all data as time series to a computers storage device
\end{itemize}

To achieve this, the setup in \autoref{fig:interfacingFlute_atteneval-setup} is used.
The supply and control voltage are generated by a Keysight 34972A with a 34907A module (see \autoref{app:keysight-34972A}).
To get a more accurate measurement of the actual voltages, two digital multimeters(Models 34470A and 34411A, see \autoref{app:keysight-34470A}) are connected directly at the $V_{control}$ and $V_+$ pins.
The \gls{rf} signal is generated by a Rhode und Schwarz SMC 100A signal generator.
With the HP E4419B and its two inputs and a power splitter, it is possible to directly get the attenuation of the ZX73-2500-S+.
The body temperature of the device is monitored with a PT100 temperature sensor connected to the 34972A.

Each of the lab devices used is compatible with \gls{vxi-11}, which is a widely adopted standard that is used to send \gls{ascii} \gls{scpi} commands over an ethernet network (called \gls{lxi}) or \gls{gpib}.\cite{lxi2021}
This enables remote and programatically control of the devices over the network.
With the library \textit{python-vxi11}, it is now possible to write a custom script, that sets the measurement devices to known initial conditions, drives the inputs of the attenuator and records the generated data. Timing the output of new set-values and recording of data is done with the \textit{Advanced Python Scheduler}.\cite{apscheduler}\\ 
The whole setup of the hardware in \autoref{fig:interfacingFlute_atteneval-setup} and the Python software, a measurement frequency of about \SI{0.5}{\Hz} to \SI{1}{\Hz} can be achieved, which is enough because most measurements taken are of a static nature and in the case of the temperature influence measurement, the thermal time constant is in the order of a few seconds.
The limiting device is the HP E4419B which takes the longest to perform one measurement. Without it, measurement frequencies of over \SI{4}{\Hz} are possible.

All measurements are performed in the ``\gls{rf} lab'' in building 348 (\gls{kara} hall on KIT Campus North) which is air conditioned to about \SI{20(2)}{\celsius}.

\begin{figure}[tb]
	\centering
	\includegraphics[]{chap/InterfacingFlute/img/Output/schematic.tikz}
	\caption{Measurement setup: DUT(red), \gls{rf} generator/power splitter/meter(blue),\\ DC sources/meters(green), temperature probe(yellow)}
	\label{fig:interfacingFlute_atteneval-setup}
\end{figure}

\subsubsection{Relation between Control Voltage and Attenuation}
In this section, the relation between the control voltage and the attenuation is examined. All other parameters are kept constant:
\begin{equation}
A(\vec{x}) := A(V_{control})
\end{equation}

The measured spectra in \autoref{fig:interfacingFlute_atteneval-overview-NA} already suggest that there is a non linear relationship between the control voltage $V_{control}$ and the attenuation $A(V_{control})$ of the attenuator:
\begin{equation}
A(V_{control}) \neq const. \cdot V_{control} + A_0.
\end{equation}
This also means the sensitivity
\begin{equation}
S(V_{control}) := \frac{\Delta A(V_{control})}{\Delta V_{control}}
\end{equation}
is not a constant.
In other words, for a desired relative change in attenuation, the needed adjustment in $V_{control}$ depends on the chosen operating point $A_o=A(V_{control,o})$.

With all other variables being at the operating point in \autoref{eq:interfacingFlute_operatingpoint}, $A(V_{control})$ is measured by stepping $V_{control}$ in \SI{0.1}{\volt} increments up and down between \SI{0}{\volt} and \SI{12}{\volt} several times with each valued held constant for \SI{30}{\second}. $A(V_{control})$ is then calculated as the mean of all measurements $A_j(V_{control})$ with the same $V_{control}$ with

\begin{equation}\label{eq:interfacingFlute_avg}
A(V_{control}) = \frac{1}{N} \sum_{j=0}^{N-1} A_j(V_{control}).
\end{equation}

With the averaging done in \autoref{eq:interfacingFlute_avg} and $N=120$, the resulting mean standard deviation is $\sigma_A=\SI{0.00574}{\dB}$.
\autoref{fig:interfacingFlute_attenDatten} shows the resulting plot.

The plot shows the attenuation can be varied over more than \SI{30}{\dB} and the magnitude of the sensitivity being large for small control voltages (\SIrange{1}{3}{\volt}).
Since the required change in attenuation of less than \SI{1}{\dB} is much smaller, it is only necessary to vary $V_{control}$ around the operating point.

The optimal operating point for $V_{control}$ is selected by considering the following three aspects.
First, the absolute attenuation at the operating point should be as low as possible to not worsen the \gls{snr} of the signal path. Second the control voltage has to fit in the possible output voltage range of the voltage source and still allow for adjustment towards both lower and higher voltages. 
In case of the Keysight 34972A/34907A the maximum possible output voltage is \SI{12}{\volt}.
Third, the sensitivity should be as low as feasible to make the attenuation less susceptible to noise on the $V_{control}$ input.


For these reasons, $V_{control,o}=\SI{10}{\volt}$ (as already used in \autoref{eq:interfacingFlute_operatingpoint}) is chosen as the operating point, which allows $V_{control}$ to be varied in \SIrange{8}{12}{\volt}.
At the operating point $\vec{x_o}$ (with $V_{control,o}=\SI{10}{\volt}$), the measured attenuation is
\begin{equation}
A(V_{control})=\SI{6.4859}{\dB}
\end{equation}
\autoref{fig:interfacingFlute_attenDattenZoomed} shows the attenuation and sensitivity around the operating point.

The sensitivity at the operating point is determined with discrete forward differentiation as
\begin{equation}
S(V_{control})=S(\SI{10}{\volt})=\frac{\Delta A}{\Delta V_{control}} = \SI{-0.151}{\dB\per\volt}.
\end{equation}

For further error calculations, the maximum $\nicefrac{\Delta A(V_{control})}{\Delta V_{control}}$ is needed. \autoref{fig:interfacingFlute_attenDattenZoomed} shows the maximum magnitude of $\nicefrac{\Delta A(V_{control})}{\Delta V_{control}}$ to be at the lower edge of the $V_{control}$ range of $S(\SI{8}{\volt})$:
\begin{equation}
\left[\frac{\Delta A(V_{control})}{\Delta V_{control}}\right]_{\text{max}}=\SI{-0.242}{\dB\per\volt}
\end{equation}

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/attenAndDattten.tikz}
	\caption{Measured attenuation $A(V_{control},f=\SI{3}{\GHz})$ of the ZX73-2500-S+ as a function of the control voltage input $V_{control}$ along with the sensitivity $S(V_{control},f=\SI{3}{\GHz})$}
	\label{fig:interfacingFlute_attenDatten}
\end{figure}

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/attenAndDatttenZoomed.tikz}
	\caption{Zoomed in version of \autoref{fig:interfacingFlute_attenDatten} shows the attenuation and sensitivity around the operating point $V_{control,o}=\SI{10}{\volt}$}
	\label{fig:interfacingFlute_attenDattenZoomed}
\end{figure}

The minimum possible step size of the attenuation can be calculated using $\left[\nicefrac{\Delta A(V_{control})}{\Delta V_{control}}\right]_{\text{max}}$ and the DAC output resolution of the Keysight 34907A ($\nicefrac{\SI{24}{\volt}}{2^{16}-1}=\SI{366.22}{\micro\volt}$):
\begin{equation}
\delta A(V_{control}) = \SI{0.242}{\dB\per\volt} \cdot \SI{366.22}{\micro\volt} = \SI{0.00008862524}{\dB}
\end{equation}

To assess the stability of $V_{control}$, delivered from the Keysight 34972A (see \autoref{app:keysight-34972A}) \gls{dac}, its stability over the course of one day is measured. For that the voltage is taken once every 2 seconds with a Keysight 34470A multimeter (see \autoref{app:keysight-34470A}). The result is shown in \autoref{fig:interfacingFlute_vcontrolstab_longterm}.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/Vcontrolstab.tikz}
	\caption{Long term stability of $V_{control}$ as delivered by the Keysight 34972A DAC (ch. 205); measured with Keysight 34470A;\\room temperature during measurement: $\mu_\vartheta=\SI{19.12}{\degreeCelsius}$, $\sigma_\vartheta=\SI{0.28}{\degreeCelsius}$}
	\label{fig:interfacingFlute_vcontrolstab_longterm}
\end{figure}

This measurement shows the stability of $V_{control}$ to be
\begin{equation}
\sigma_{V_{control}} = \SI{0.173}{\milli\volt}
\end{equation}

\subsubsection{Influence of Supply Voltage Noise on Attenuation}
To get the required stability for the power supply voltage, the effect of the supply voltage $V_+$ on the attenuation $\nicefrac{\Delta A}{\Delta V_+} (V_+)$ has to be examined first. To do that $V+$ is varied \SI{\pm0.2}{\volt} around the nominal supply voltage at the operating point $V_{+_o}=\SI{3}{\volt}$, all other parameters are kept constant and the attenuation is measured. To make the measurement more robust against fluctuations of the room temperature and drift of the devices, the procedure of stepping through the voltages is repeated in a similar fashion as for the influence of $V_{control}$ and the means for each set $V_+$ are computed. The result is shown in \autoref{fig:interfacingFlute_atteneval-vsupp-influence}.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/VsuppStab/influenceVplus.tikz}
	\caption{Influence of the supply voltage $V_+$ on the attenuation}
	\label{fig:interfacingFlute_atteneval-vsupp-influence}
\end{figure}

The plot shows $A(V_+)$ to be of linear nature over the measured range.
Therefore using a linear regression of the measured data points, the influence on the attenuation can be estimated to
\begin{equation}
\frac{\Delta A(V_+)}{\Delta V_+}(V_+) 
\approx \frac{\Delta A(V_+)}{V_+} 
= \left[\frac{\Delta A(V_+)}{V_+}\right]_\text{max}
=\SI{0.0035592}{\dB\per\volt}.
\end{equation}

Next the stability of the supply voltage is measured.
for that the stability over the course of one day is measured. The voltage is taken once every two seconds with a Keysight 34470A multimeter (see \autoref{app:keysight-34470A}). The result is shown in \autoref{fig:interfacingFlute_atteneval-vsupp-stability}.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/VsuppStab/stabilityVplus.tikz}
	\caption{Long term stability of $V_{+}$ as delivered by the Keysight 34972A DAC (ch. 204); measured with Keysight 34470A;\\room temperature during measurement: $\mu_\vartheta=\SI{19.12}{\degreeCelsius}$, $\sigma_\vartheta=\SI{0.28}{\degreeCelsius}$}
	\label{fig:interfacingFlute_atteneval-vsupp-stability}
\end{figure}

Comparing \autoref{fig:interfacingFlute_atteneval-vsupp-stability} with \autoref{fig:interfacingFlute_vcontrolstab_longterm} suggest a relation between the deviations in $V_{control}$ and $V_+$. Since they are both generated by the same Keysight 34907A module, this is plausible. The slightly changing room temperature is assumed to be the common cause.
By calculating the correlation coefficients between $\Delta V_+$ and $\Delta V_{control}$ and also between $\Delta V_+$ and $\Delta \vartheta_{ambient}$, this can be verified:
\begin{align}
\text{Corr}(\Delta V_+,\Delta V_{control})         &= \num{0.99204} \\
\text{Corr}(\Delta V_+,\Delta \vartheta_{ambient}) &= \num{-0.92242} \\
\end{align}

The long term measurement yields a standard deviation of
\begin{equation}
\sigma_{V,+,longterm} = \SI{0.154}{\milli\volt},
\end{equation}
which is also used as the worst case stability
\begin{equation}
\sigma_{V_+} = \SI{0.154}{\milli\volt}
\end{equation}

There is also a constant offset of $\mu_{V,+,longterm}=\SI{-1.35}{\milli\volt}$, but it is disregarded since it can easily be compensated by slightly increasing the supply voltage.

\subsubsection{Influence of RF Frequency on Attenuation}
In this section the influence of a varying \gls{rf} frequency on attenuation $\nicefrac{\Delta A}{\Delta f} (f)$ is examined. For that the set frequency of the R\&S SMC100 signal generator is varied while the attenuation is measured. The result is shown in \autoref{fig:interfacingFlute_atteneval-rf}.

\begin{figure}[tb]
    \centering
        \subfloat[$f=f_o \SI{+-30}{\kHz}$]{\input{chap/InterfacingFlute/img/Output/bunkerRF/influenceRFbunkerFull.tikz}}
        \qquad
        \subfloat[$f=f_o \SI{+-1}{\kHz}$]{\input{chap/InterfacingFlute/img/Output/bunkerRF/influenceRFbunkerZoomed.tikz}}
       \caption{Influence of an offset frequency $f-\SI{3}{\GHz}$ on the attenuation }
    \label{fig:interfacingFlute_atteneval-rf}
\end{figure}

Phase noise measurements of the \gls{flute} main oscillator\footnote{Using the phase noise analyzer HA7062C by Holzworth, see \autoref{app:holzworth-ha7062c}} yield the phase noises
\begin{align}
\mathscr{L}(f_o=\SI{10}{\hertz}) &= \SI{-78.63}{\dB c}\\
\mathscr{L}(f_o=\SI{1}{\kilo\hertz}) &= \SI{-116.26}{\dB c}\\
\mathscr{L}(f_o=\SI{10}{\kilo\hertz}) &= \SI{-139.29}{\dB c}\\
\mathscr{L}(f_o=\SI{1}{\mega\hertz}) &= \SI{-142.29}{\dB c},
\end{align}

with $f_o$ being the offset frequency from the carrier and the unit \si{\dB c} measuring the offset power from the carrier.

Since this shows the oscillator to be much more stable than $f_o=\SI{10}{\kHz}$, is it is sufficient to consider only \autoref{fig:interfacingFlute_atteneval-rf} (b). In the range of \SI{\pm1}{\kHz} around the operating point frequency of \SI{3}{\GHz}, $\nicefrac{\Delta A}{\Delta f} (f)$ is almost constant. From the data points, the value can be calculated to
\begin{equation}
\frac{\Delta A(f)}{\Delta f}(f) 
\approx \frac{\Delta A(f)}{\Delta f} 
= \left[\frac{\Delta A(f)}{\Delta f}\right]_\text{max}
=\SI{0.0000046619}{\dB\per\hertz}.
\end{equation}

\subsubsection{Influence of Case Temperature Variations on Attenuation}
To get insight into the importance of a stable case temperature, its influence on the attenuation $\nicefrac{\Delta A}{\Delta \vartheta_{case}} (\vartheta_{case})$ and the temperature stability both in the ``\gls{rf} lab'' and the final mounting position inside the FLUTE \gls{llrf} cabinet are measured.

To measure $\nicefrac{\Delta A}{\Delta \vartheta_{case}} (\vartheta_{case})$, the following experimental setup is used.\\
The bottom of the attenuator is fixed to a rectangular iron profile with zip ties. Then the iron profile is heated with the tip of a soldering iron (set to \SI{150}{\degreeCelsius}) for \SI{1}{\minute} and then allowed to cool for \SI{20}{\minute}. This cycle is repeated three times and the device temperature and the attenuation are measured once every \SI{2}{\second}. Due to heat flowing from the soldering iron to the iron profile and through device itself, a strong hysteresis between the heating and cooling cycle can be observed in \autoref{fig:interfacingFlute_atteneval-tempstab-influence}.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/temperature/influenceTemp.tikz}
	\caption{Raw measurement result of the influence of the case temperature $\vartheta_{case}$ on the attenuation; color coded is the relative elapsed time of the measurement}
	\label{fig:interfacingFlute_atteneval-tempstab-influence}
\end{figure}

To get $\nicefrac{\Delta A}{\Delta \vartheta_{case}} (\vartheta_{case})$ from the plot in \autoref{fig:interfacingFlute_atteneval-tempstab-influence} an approximately linear relationship $A(\vartheta_{case})$ is assumed. To get the slope, the $\vartheta_{case}$ component of the measured data points $(\vartheta_{case}|A(\vartheta_{case}))$ are rounded to one decimal place. Then data points with the same $A(\vartheta_{case})$ are averaged together and a linear regression is applied to the result. See \autoref{fig:interfacingFlute_atteneval-tempstab-influenceMean} for the resulting plot. The linear regression estimator yields
\begin{equation}
\frac{\Delta A}{\Delta \vartheta_{case}} (\vartheta_{case})
\approx \frac{\Delta A}{\Delta \vartheta_{case}}
= \left[\frac{\Delta A}{\Delta \vartheta_{case}}\right]_\text{max}
= \SI{0.00432449}{\dB\per\celsius}.
\end{equation}

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/temperature/influenceTempmean.tikz}
	\caption{Influence of the case temperature $\vartheta_{case}$ on the attenuation}
	\label{fig:interfacingFlute_atteneval-tempstab-influenceMean}
\end{figure}

Next, the temperature stability in both the ``\gls{rf} lab'' and in the FLUTE \gls{llrf} cabinet is measured. For that in each environment the temperature is recorded over night with a thermo element connected to the Keysight 34907A inside the Keysight 34972A every two seconds.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.5\textwidth]{chap/InterfacingFlute/img/Output/temperature/tempStability.tikz}
	\caption{Comparison between the temperature stability in the ``\gls{rf} lab'' and inside the FLUTE \gls{llrf} cabinet}
	\label{fig:interfacingFlute_atteneval-tempstab-time}
\end{figure}

From the data in \autoref{fig:interfacingFlute_atteneval-tempstab-time}, the corresponding stabilities are calculated to be
\begin{align}
\sigma_{\vartheta_{ambient, \text{RF lab}}}       &= \SI{0.1067}{\celsius}\\
\sigma_{\vartheta_{ambient, \text{LLRF cabinet}}} &= \SI{0.0288}{\celsius}.
\end{align}
This assumes the case of the attenuator and the ambient around it being in thermal equilibrium. With the thick brass case and its only weakly mechanically mounting to the metal support, the attenuator posses a significant thermal time constant $\tau_{th}=R_{th}C_{th}$. Therefore, thermally the attenuator is a lowpass filter and cannot follow fast changes in the ambient temperature.
This means only slow changes of the ambient temperature have an influence on $A$, so short changes, like opening a door, have only a minor effect.

\subsubsection{$V_{control}$ Frequency response}\label{sec:interfacingFlute_freqr}
Using a non inverting adder with a \textit{TS912IN} operational amplifier, a sine wave with constant offset is made, which is then used to drive the control voltage $V_{control}$. The result for different sine wave frequencies is shown in \autoref{fig:interfacingFlute_atteneval-freqresp}.

This result is to be interpreted purely qualitatively, as neither measurement device and software is designed, nor is the circuit used optimal.
But the traces in \autoref{fig:interfacingFlute_atteneval-freqresp} verify that the ZX73-2500-S+ attenuator is able to follow changes of $V_{control}$ at least up to a few ten \si{\kHz}. If the attenuator should be set to a new value, this is equivalent to applying a step at the attenuators $V_{control}$ input, which according to the Fourier transform of a $\text{rect}(t)$ pulse, a $\text{sinc}(f)$ contains high frequencies.

This is at several orders of magnitude bigger than the control system can input, compute and output new values to the attenuator.

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.6\textwidth]{chap/InterfacingFlute/img/Output/holzworth.tikz}
	\caption{Spectrum (measured with Holzworth HA7062A (\autoref{app:holzworth-ha7062c})) showing the effect of modulating $V_{control}$ with different frequencies (Modulation amplitude: \SI{1}{\volt})}
	\label{fig:interfacingFlute_atteneval-freqresp}
\end{figure}

\subsubsection{Combined Maximum Error of the Attenuation and Conclusion}
Using \autoref{eq:interfacingFlute_maxerror} and setting $\Delta x_j = \sigma_{x_j}$ and $\nicefrac{\Delta A}{\Delta x_j} = \left[\nicefrac{\Delta A}{\Delta x_j}\right]_\text{max}$, the upper bound on the deviation of the attenuation, that is the error $\Delta A$ in the worst case, can now be calculated:
\begin{align}
\Delta A_{\text{max}} &= \sum_{j=0}^{3} \left|\frac{\Delta A}{\Delta x_j} \cdot \Delta x_j\right|\\
                      &= \left|\frac{\Delta A}{\Delta V_{control}} \cdot \Delta V_{control}\right|
                      +  \left|\frac{\Delta A}{\Delta V_{+}} \cdot \Delta V_{+}\right|
                      +  \left|\frac{\Delta A}{\Delta f} \cdot \Delta f\right|
                      +  \left|\frac{\Delta A}{\Delta \vartheta_{case}} \cdot \Delta \vartheta_{case}\right|\\
                      &=       \underbrace{\SI{0.242}{\dB\per\volt} \cdot \SI{0.173}{\milli\volt}}_{\SI{41.9}{\micro\dB\relax}}\\
                      &\quad+  \underbrace{\SI{0.0035592}{\dB\per\volt} \cdot \SI{0.154}{\milli\volt}}_{\SI{548}{\nano\dB\relax}}\\
                      &\quad+  \underbrace{\SI{0.00000466}{\dB\per\hertz} \cdot \SI{0}{\hertz}}_{\SI{0}{\dB\relax}}\\
                      &\quad+  \underbrace{\SI{0.004325}{\dB\per\celsius} \cdot \SI{0.11}{\celsius}}_{\SI{475.75}{\micro\dB\relax}}\\
                      &= \SI{518}{\micro\dB\relax} = \SI{0.000518}{\dB}
\end{align}

This shows even in the worst case, the ZX73-2500-S+ attenuator is stable within the requirement.

The other requirements from \autoref{tab:interfacingFlute_rfattenrequirements} are also fulfilled, see \autoref{tab:interfacingFlute_rfattenrequirements_result}.

\begin{table}[tbh]
\caption{Controllable \gls{rf} attenuator evaluation test results}
\label{tab:interfacingFlute_rfattenrequirements_result}
\centering
\begin{tabular}{lccl}
	\toprule
	Requirement                            &      {Value/Range} set      &  {Value/Range} actual   & Verdict \\ \midrule
	attenuation adjustment                 &    $\ge\SI{\pm0.2}{\dB}$    &    \SI{\pm0.3}{\dB}     & pass    \\
	attenuation stability                  &   $\le\SI{\pm0.001}{\dB}$   &   \SI{0.000518}{\dB}    & pass    \\
	nominal attenuation at operating point &      $\le\SI{10}{\dB}$      &      \SI{6.6}{\dB}      & pass    \\
	attenuation resolution                 &    $\le\SI{0.001}{\dB}$     &   \SI{0.000089}{\dB}    & pass    \\
	setup time                             & $\le\SI{10}{\milli\second}$ &       \SI{1}{\ms}       & pass    \\
	operating temperature range            &   \SI{25\pm0.1}{\celsius}   & \SI{25\pm0.1}{\celsius} & pass    \\
	supply voltage                         &   \SIrange{3}{12}{\volt}    &      \SI{3}{\volt}      & pass    \\
	control voltage                        &   \SIrange{3}{12}{\volt}    & \SIrange{8}{12}{\volt}  & pass    \\ \bottomrule
\end{tabular}
\end{table}

\subsection{Test of the Attenuator with FLUTE}
In this section the attenuator in mounted at \gls{flute} and its function is verified against the data gathered in the lab in earlier sections.

The attenuator is installed at its final mounting location inside the \gls{llrf} cabinet in the \gls{flute} bunker basement and is connected between the output of the vector modulator (after the oscillator, not shown in \autoref{fig:fluteEgun-rfschematic}) and the input of the pre-amplifier. With the controllable attenuator at its operating point, the signal path now contains an attenuation of about \SI{6}{\dB} at all times.

After all components of \gls{flute} are warmed up to operational temperatures, the attenuation versus control voltage curve $A(V_\text{control})$ is measured again (compare the lab measurement \autoref{fig:interfacingFlute_attenDatten}).

To do so, the control voltage $V_\text{control}$ is varied in \SI{0.5}{\volt} steps (see \autoref{fig:interfacingFlute_finalTest_calv}), with each step kept for \SI{20}{\minute}. Synchronous to that, the \gls{rf} power of the cavity is recorded (see \autoref{fig:interfacingFlute_finalTest_calp}), from which the attenuation $A$ can be calculated. Computing the averaging over each step yields $A(V_\text{control})$. It is depicted in \autoref{fig:interfacingFlute_finalTest} together with its uncertainty.


\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.4\textwidth]{chap/InterfacingFlute/img/Output/cal/cal_V.tikz}
	\caption{Time signal $V_\text{control}$ used to calculate \autoref{fig:interfacingFlute_finalTest}}
	\label{fig:interfacingFlute_finalTest_calv}
\end{figure}

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.4\textwidth]{chap/InterfacingFlute/img/Output/cal/cal_P.tikz}
	\caption{Time signal $A(V_\text{control})$ used to calculate \autoref{fig:interfacingFlute_finalTest}}
	\label{fig:interfacingFlute_finalTest_calp}
\end{figure}

\begin{figure}[tb]
	\centering
	\includegraphics[width=\textwidth,height=0.7\textwidth]{chap/InterfacingFlute/img/Output/attenFluteErrorbars.tikz}
	\caption{Measured $A(V_\text{control})$ with \gls{flute}; error bars show the span between minimum and maximum values in each $V_\text{control}$ step}
	\label{fig:interfacingFlute_finalTest}
\end{figure}



